{% extends "base.html" %}
{% block title %}ç®¡ç†å‘˜é¢æ¿ â€” å¤ªé¼“æŠ•ç¨¿{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header animate-in">
        <h1>âš™ï¸ ç®¡ç†å‘˜é¢æ¿</h1>
        <p>å®¡æ ¸æŠ•ç¨¿ã€ç®¡ç†ç¤¾åŒºå†…å®¹</p>
    </div>

    <!-- Tabs -->
    <div class="tabs animate-in" style="animation-delay:0.05s;">
        <a href="{{ url_for('admin_panel', tab='pending') }}"
            class="tab-link {% if tab == 'pending' %}active{% endif %}">
            å®¡æ ¸ä¸­
        </a>
        <a href="{{ url_for('admin_panel', tab='approved') }}"
            class="tab-link {% if tab == 'approved' %}active{% endif %}">
            å·²é€šè¿‡
        </a>
        <a href="{{ url_for('admin_panel', tab='rejected') }}"
            class="tab-link {% if tab == 'rejected' %}active{% endif %}">
            å·²æ‹’ç»
        </a>
    </div>

    {% if submissions.items %}
    <div class="table-wrapper animate-in" style="animation-delay:0.1s;">
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>æ›²å</th>
                    <th>æŠ•ç¨¿è€…</th>
                    <th>åˆ†ç±»</th>
                    <th>ä¸Šä¼ æ—¶é—´</th>
                    <th>æ–‡ä»¶</th>
                    {% if tab == 'pending' %}
                    <th>å®¡æ ¸</th>
                    {% else %}
                    <th>å¤‡æ³¨</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody>
                {% for sub in submissions.items %}
                <tr>
                    <td style="color:var(--text-muted);">#{{ sub.id }}</td>
                    <td>
                        <strong>{{ sub.title }}</strong>
                        {% if sub.artist %}<br><span style="color:var(--text-muted);font-size:0.78rem;">{{ sub.artist
                            }}</span>{% endif %}
                    </td>
                    <td>{{ sub.author.username }}</td>
                    <td><span class="card-badge badge-category">{{ sub.song_type }}</span></td>
                    <td style="font-size:0.8rem; color:var(--text-muted);">
                        {{ sub.created_at.strftime('%Y-%m-%d %H:%M') }}
                    </td>
                    <td style="font-size:0.8rem;">
                        <a href="{{ url_for('admin_preview_file', sid=sub.id, filename=sub.tja_filename) }}"
                            target="_blank" class="btn btn-outline btn-sm">TJA</a>
                        <a href="{{ url_for('admin_preview_file', sid=sub.id, filename=sub.ogg_filename) }}"
                            target="_blank" class="btn btn-outline btn-sm">OGG</a>
                    </td>
                    {% if tab == 'pending' %}
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="toggleReview({{ sub.id }})">å®¡æ ¸</button>
                        <div class="review-inline" id="review-{{ sub.id }}">
                            <form method="POST" action="{{ url_for('admin_review', sid=sub.id) }}">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <div class="form-group" style="margin-bottom:0.5rem;">
                                    <select name="action" class="form-control"
                                        style="font-size:0.8rem; padding:0.4rem;">
                                        <option value="approve">âœ… é€šè¿‡ï¼ˆä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼‰</option>
                                        <option value="reject">âŒ æ‹’ç»</option>
                                    </select>
                                </div>
                                <div class="form-group" style="margin-bottom:0.5rem;">
                                    <textarea name="review_note" class="form-control" placeholder="å®¡æ ¸å¤‡æ³¨ï¼ˆé€‰å¡«ï¼‰" rows="2"
                                        style="font-size:0.8rem; padding:0.4rem; min-height:50px;"></textarea>
                                </div>
                                <button type="submit" class="btn btn-success btn-sm">ç¡®è®¤æäº¤</button>
                            </form>
                        </div>
                    </td>
                    {% else %}
                    <td style="font-size:0.8rem; color:var(--text-secondary); max-width:200px;">
                        {{ sub.review_note or 'â€”' }}
                    </td>
                    {% endif %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    {% if submissions.pages > 1 %}
    <div class="pagination">
        {% if submissions.has_prev %}
        <a href="{{ url_for('admin_panel', tab=tab, page=submissions.prev_num) }}">â€¹</a>
        {% else %}
        <span class="disabled">â€¹</span>
        {% endif %}

        {% for p in submissions.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
        {% if p %}
        <a href="{{ url_for('admin_panel', tab=tab, page=p) }}"
            class="{% if p == submissions.page %}active-page{% endif %}">{{ p }}</a>
        {% else %}
        <span style="color:var(--text-muted);">â€¦</span>
        {% endif %}
        {% endfor %}

        {% if submissions.has_next %}
        <a href="{{ url_for('admin_panel', tab=tab, page=submissions.next_num) }}">â€º</a>
        {% else %}
        <span class="disabled">â€º</span>
        {% endif %}
    </div>
    {% endif %}

    {% else %}
    <div class="empty-state animate-in" style="animation-delay:0.1s;">
        <span class="icon">ğŸ“­</span>
        <p>
            {% if tab == 'pending' %}æš‚æ— å¾…å®¡æ ¸æŠ•ç¨¿
            {% elif tab == 'approved' %}æš‚æ— å·²é€šè¿‡æŠ•ç¨¿
            {% else %}æš‚æ— å·²æ‹’ç»æŠ•ç¨¿
            {% endif %}
        </p>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
    function toggleReview(id) {
        const el = document.getElementById('review-' + id);
        el.classList.toggle('open');
    }
</script>
{% endblock %}